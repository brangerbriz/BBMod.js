<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src\modules\BB.MidiDevice.js - liBB.js</title>
        
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/prettify-nick.css">

    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    
    <script src="../assets/vendor/yui-min.js"></script>
</head>
<body>

<div id="doc">
    <div id="bd" class="main-body">

        <div id="docs-sidebar" class="sidebar apidocs">
            <div id="api-list">
                <div id="api-tabview" class="tabview">
                    <ul class="tabs">
                        <a href="/docs">
                            <img src="../assets/favicon.png" class="icon"/>
                        </a>
                        <a href="/docs" class="homelink"> liBB.js </a>
                        <!-- <li><a href="#api-classes">Classes</a></li> -->
                        <!-- <li><a href="#api-modules">Modules</a></li> -->
                    </ul>
            
                    <div id="api-tabview-filter">
                        <input type="search" id="api-filter" placeholder="Type to filter APIs">
                    </div>
            
                    <div id="api-tabview-panel">
                        <ul id="api-classes" class="apis classes">
                            <li><a class="type" href="../classes/BB.AudioAnalyser.html">BB.AudioAnalyser</a></li>
                            <li><a class="type" href="../classes/BB.AudioBufferLoader.html">BB.AudioBufferLoader</a></li>
                            <li><a class="type" href="../classes/BB.AudioSampler.html">BB.AudioSampler</a></li>
                            <li><a class="type" href="../classes/BB.AudioStream.html">BB.AudioStream</a></li>
                            <li><a class="type" href="../classes/BB.BaseBrush2D.html">BB.BaseBrush2D</a></li>
                            <li><a class="type" href="../classes/BB.BaseMidiInput.html">BB.BaseMidiInput</a></li>
                            <li><a class="type" href="../classes/BB.BrushManager2D.html">BB.BrushManager2D</a></li>
                            <li><a class="type" href="../classes/BB.Color.html">BB.Color</a></li>
                            <li><a class="type" href="../classes/BB.ImageBrush2D.html">BB.ImageBrush2D</a></li>
                            <li><a class="type" href="../classes/BB.LineBrush2D.html">BB.LineBrush2D</a></li>
                            <li><a class="type" href="../classes/BB.MathUtils.html">BB.MathUtils</a></li>
                            <li><a class="type" href="../classes/BB.MidiDevice.html">BB.MidiDevice</a></li>
                            <li><a class="type" href="../classes/BB.MidiInputButton.html">BB.MidiInputButton</a></li>
                            <li><a class="type" href="../classes/BB.MidiInputKey.html">BB.MidiInputKey</a></li>
                            <li><a class="type" href="../classes/BB.MidiInputKnob.html">BB.MidiInputKnob</a></li>
                            <li><a class="type" href="../classes/BB.MidiInputPad.html">BB.MidiInputPad</a></li>
                            <li><a class="type" href="../classes/BB.MidiInputSlider.html">BB.MidiInputSlider</a></li>
                            <li><a class="type" href="../classes/BB.MouseInput.html">BB.MouseInput</a></li>
                            <li><a class="type" href="../classes/BB.Particle2D.html">BB.Particle2D</a></li>
                            <li><a class="type" href="../classes/BB.Pointer.html">BB.Pointer</a></li>
                            <li><a class="type" href="../classes/BB.Vector2.html">BB.Vector2</a></li>
                        </ul>
            
                      <!--   <ul id="api-modules" class="apis modules">
                            <li><a class="module" href="../modules/BB.AudioAnalyser.html">BB.AudioAnalyser</a></li>
                            <li><a class="module" href="../modules/BB.AudioBufferLoader.html">BB.AudioBufferLoader</a></li>
                            <li><a class="module" href="../modules/BB.AudioSampler.html">BB.AudioSampler</a></li>
                            <li><a class="module" href="../modules/BB.AudioStream.html">BB.AudioStream</a></li>
                            <li><a class="module" href="../modules/BB.BaseBrush2D.html">BB.BaseBrush2D</a></li>
                            <li><a class="module" href="../modules/BB.BaseMidiInput.html">BB.BaseMidiInput</a></li>
                            <li><a class="module" href="../modules/BB.BrushManager2D.html">BB.BrushManager2D</a></li>
                            <li><a class="module" href="../modules/BB.Color.html">BB.Color</a></li>
                            <li><a class="module" href="../modules/BB.ImageBrush2D.html">BB.ImageBrush2D</a></li>
                            <li><a class="module" href="../modules/BB.LineBrush2D.html">BB.LineBrush2D</a></li>
                            <li><a class="module" href="../modules/BB.MathUtils.html">BB.MathUtils</a></li>
                            <li><a class="module" href="../modules/BB.Midi.html">BB.Midi</a></li>
                            <li><a class="module" href="../modules/BB.MouseInput.html">BB.MouseInput</a></li>
                            <li><a class="module" href="../modules/BB.particle2D.html">BB.particle2D</a></li>
                            <li><a class="module" href="../modules/BB.Pointer.html">BB.Pointer</a></li>
                            <li><a class="module" href="../modules/BB.Vector2.html">BB.Vector2</a></li>
                        </ul> -->
                    </div>
                </div>
            </div>
        </div>

        <div id="docs-main" class="apidocs">
            <div class="content container">
    <h1 class="file-heading">File: src\modules\BB.MidiDevice.js</h1>
    
    <div class="file">
    <pre class="code prettyprint overflow linenums">
    /**
     * A module for receiving midi messages via USB in the browser. Google Chrome
     * support only at the moment. See support for the Web MIDI API
     * (https://webaudio.github.io/web-midi-api/).
     * @module BB.Midi
     */
    define([&#x27;./modules/BB&#x27;,
            &#x27;./modules/BB.BaseMidiInput&#x27;, 
            &#x27;./modules/BB.MidiInputButton&#x27;, 
            &#x27;./modules/BB.MidiInputKey&#x27;, 
            &#x27;./modules/BB.MidiInputKnob&#x27;, 
            &#x27;./modules/BB.MidiInputPad&#x27;, 
            &#x27;./modules/BB.MidiInputSlider&#x27;], 
    function(  BB,
               BaseMidiInput,
               MidiInputButton,
               MidiInputKey,
               MidiInputKnob,
               MidiInputPad,
               MidiInputSlider){
    
        &#x27;use strict&#x27;;
    
        BB.BaseMidiInput   = BaseMidiInput;
        BB.MidiInputButton = MidiInputButton;
        BB.MidiInputKey    = MidiInputKey;
        BB.MidiInputKnob   = MidiInputKnob;
        BB.MidiInputPad    = MidiInputPad;
        BB.MidiInputSlider = MidiInputSlider;
    
        /**
         * A class for recieving input from Midi controllers in the browser using
         * the experimental Web MIDI API. This constructor returns true if browser
         * supports Midi and false if not.
         * 
         * &lt;em&gt;NOTE: This implementation of
         * BB.MidiDevice currently only supports using one MIDI device connected to
         * the browser at a time. More than one may work but you may run into note
         * clashing and other oddities.&lt;/em&gt;
         * &lt;br&gt;&lt;br&gt;
         * &lt;img src=&quot;../../examples/assets/images/midi.png&quot;/&gt;
         * 
         * @class  BB.MidiDevice
         * @constructor
         * @param {Object} midiMap An object with array properties for knobs, sliders, buttons, keys, and pads.
         * @param {Function} success Function to return once MIDIAccess has been received successfully.
         * @param {Function} failure Function to return if MIDIAccess is not received successfully.
         */
        BB.MidiDevice = function(midiMap, success, failure) {
            
            if (typeof midiMap !== &#x27;object&#x27;) {
                throw new Error(&quot;BB.MidiDevice: midiMap parameter must be an object&quot;);
            } else if (typeof success !== &#x27;function&#x27;) {
                throw new Error(&quot;BB.MidiDevice: success parameter must be a function&quot;);
            } else if (typeof failure !== &#x27;function&#x27;) {
                throw new Error(&quot;BB.MidiDevice: failure parameter must be a function&quot;);
            }
    
            var self = this;
    
            /**
             * Dictionary of Midi input object arrays. Includes sliders, knobs,
             * buttons, pads, and keys (only if they are added in the midiMap passed
             * into the constructor).
             * @property inputs
             * @type {Object}
             */
            this.inputs = {
                sliders: [],
                knobs: [],
                buttons: [],
                pads: [],
                keys: []
            };
    
            /**
             * The Web MIDI API midiAccess object returned from navigator.requestMIDIAccess(...)
             * @property midiAccess
             * @type {MIDIAccess}
             * @default null
             */
            this.midiAccess = null;
    
            this._connectEvent = null;
            this._disconnectEvent = null;
            this._messageEvent = null;
    
            // note COME BACK
            var noteLUT = {}; // lookup table
    
            var input = null;
    
            var i = 0;
            var key = null;
            var note = null;
            
            // sliders
            if (typeof midiMap.sliders !== &#x27;undefined&#x27; &amp;&amp; midiMap.sliders instanceof Array) {
                for (i = 0; i &lt; midiMap.sliders.length; i++) {
                    input = new BB.MidiInputSlider(midiMap.sliders[i]);
                    note = (typeof midiMap.sliders[i] === &#x27;number&#x27;) ? midiMap.sliders[i] : midiMap.sliders[i].note;
                    key = &#x27;key&#x27; + note;
                    if (typeof noteLUT[key] === &#x27;undefined&#x27;) {
                        noteLUT[key] = [];
                    }
                    noteLUT[key].push([ input, i ]);
                    self.inputs.sliders.push(input);
                }
            }
    
            // knobs
            if (typeof midiMap.knobs !== &#x27;undefined&#x27; &amp;&amp; midiMap.knobs instanceof Array) {
                for (i = 0; i &lt; midiMap.knobs.length; i++) {
                    input = new BB.MidiInputKnob(midiMap.knobs[i]);
                    note = (typeof midiMap.knobs[i] === &#x27;number&#x27;) ? midiMap.knobs[i] : midiMap.knobs[i].note;
                    key = &#x27;key&#x27; + note;
                    if (typeof noteLUT[key] === &#x27;undefined&#x27;) {
                        noteLUT[key] = [];
                    }
                    noteLUT[key].push([ input, i ]);
                    self.inputs.knobs.push(input);
                }
            }
    
            // buttons
            if (typeof midiMap.buttons !== &#x27;undefined&#x27; &amp;&amp; midiMap.buttons instanceof Array) {
                for (i = 0; i &lt; midiMap.buttons.length; i++) {
                    input = new BB.MidiInputButton(midiMap.buttons[i]);
                    note = (typeof midiMap.buttons[i] === &#x27;number&#x27;) ? midiMap.buttons[i] : midiMap.buttons[i].note;
                    key = &#x27;key&#x27; + note;
                    if (typeof noteLUT[key] === &#x27;undefined&#x27;) {
                        noteLUT[key] = [];
                    }
                    noteLUT[key].push([ input, i ]);
                    self.inputs.buttons.push(input);
                }
            }
    
            // pads
            if (typeof midiMap.pads !== &#x27;undefined&#x27; &amp;&amp; midiMap.pads instanceof Array) {
                for (i = 0; i &lt; midiMap.pads.length; i++) {
                    input = new BB.MidiInputPad(midiMap.pads[i]);
                    note = (typeof midiMap.pads[i] === &#x27;number&#x27;) ? midiMap.pads[i] : midiMap.pads[i].note;
                    key = &#x27;key&#x27; + note;
                    if (typeof noteLUT[key] === &#x27;undefined&#x27;) {
                        noteLUT[key] = [];
                    }
                    noteLUT[key].push([ input, i ]);
                    self.inputs.pads.push(input);
                }
            }
    
            // keys
            if (typeof midiMap.keys !== &#x27;undefined&#x27; &amp;&amp; midiMap.keys instanceof Array) {
                for (i = 0; i &lt; midiMap.keys.length; i++) {
                    input = new BB.MidiInputKey(midiMap.keys[i]);
                    note = (typeof midiMap.keys[i] === &#x27;number&#x27;) ? midiMap.keys[i] : midiMap.keys[i].note;
                    key = &#x27;key&#x27; + note;
                    if (typeof noteLUT[key] === &#x27;undefined&#x27;) {
                        noteLUT[key] = [];
                    }
                    noteLUT[key].push([ input, i ]);
                    self.inputs.keys.push(input);
                }
            }
    
            // request MIDI access
            if (navigator.requestMIDIAccess) {
                navigator.requestMIDIAccess({
                    sysex: false
                }).then(onMIDISuccess, failure);
            } else {
                failure();
            }
    
            // midi functions
            function onMIDISuccess(midiAccess) {
    
                self.midiAccess = midiAccess;
                var inputs = self.midiAccess.inputs.values();
                // loop through all inputs
                for (var input = inputs.next(); input &amp;&amp; !input.done; input = inputs.next()) {
                    // listen for midi messages
                    input.value.onmidimessage = onMIDIMessage;
                    // this just lists our inputs in the console
                }
                // listen for connect/disconnect message
                self.midiAccess.onstatechange = onStateChange;
                success(midiAccess);
            }
    
            function onStateChange(event) {
                
                var port = event.port,
                    state = port.state,
                    name = port.name,
                    type = port.type;
    
                if (state === &#x27;connected&#x27; &amp;&amp; self._connectEvent) {
                    self._connectEvent(name, type, port);
                } else if (state === &#x27;disconnected&#x27; &amp;&amp; self._disconnectEvent) {
                    self._disconnectEvent(name, type, port);
                }
            }
    
            function onMIDIMessage(event) {
    
                var data = event.data;
                var command = data[0] &gt;&gt; 4;
                var channel = data[0] &amp; 0xf;
                var type = data[0] &amp; 0xf0; // channel agnostic message type. Thanks, Phil Burk.
                var note = data[1];
                var velocity = data[2];
                // with pressure and tilt off
                // note off: 128, cmd: 8 
                // note on: 144, cmd: 9
                // pressure / tilt on
                // pressure: 176, cmd 11: 
                // bend: 224, cmd: 14
    
                if (self._messageEvent) {
                    self._messageEvent({
                        command: command,
                        channel: channel,
                        type: type,
                        note: note,
                        velocity: velocity
                    }, event);
                }
    
                var i = 0;
                var key = &#x27;key&#x27; + note;
    
                // if note is in noteLUT
                if (key in noteLUT) {
                    
                    var input = null;
                    var index = null;
    
                    for (i = 0; i &lt; noteLUT[key].length; i++) {
                        
                        if (noteLUT[key][i][0].command === command &amp;&amp; 
                            noteLUT[key][i][0].channel === channel) {
                            input = noteLUT[key][i][0];
                            index = noteLUT[key][i][1];
                        } 
                    }
    
                    // if no command comparison match was found
                    // use the first value in LUT
                    if (input === null) {
                        input = noteLUT[key][0][0];
                        index = noteLUT[key][0][1];
                    }
    
                    // update input&#x27;s values
                    input.command      = command;
                    input.channel      = channel;
                    input.type         = type;
                    input.velocity     = velocity;
    
                    var changeEventArr = input.eventStack.change;
    
                    var midiData = {}; // reset data
    
                    // all
                    for (i = 0; i &lt; changeEventArr.length; i++) {
                        
                        midiData = {
                            velocity: velocity,
                            channel: channel,
                            command: command,
                            type: type,
                            note: note
                        };
    
                        changeEventArr[i](midiData, input.inputType, index); // fire change event
                    }
    
                    // slider and knob
                    if (input.inputType == &#x27;slider&#x27; || input.inputType == &#x27;knob&#x27;) {
    
                        // max
                        if (velocity == 127) {
    
                            var maxEventArr = input.eventStack.max;
                            for (i = 0; i &lt; maxEventArr.length; i++) {
    
                                midiData = {
                                    velocity: velocity,
                                    channel: channel,
                                    command: command,
                                    type: type,
                                    note: note
                                };
    
                                maxEventArr[i](midiData, input.inputType, index); // fire max event
                            }
    
                        // min
                        } else if (velocity === 0) { 
    
                            var minEventArr = input.eventStack.min;
                            for (i = 0; i &lt; minEventArr.length; i++) {
    
                                midiData = {
                                    velocity: velocity,
                                    channel: channel,
                                    command: command,
                                    type: type,
                                    note: note
                                };
    
                                minEventArr[i](midiData, input.inputType, index); // fire min event
                            }
                        }
                    }
    
                    // button
                    if (input.inputType == &#x27;button&#x27;) {
    
    
                        // down
                        if (velocity == 127) {
    
                            var downEventArr = input.eventStack.down;
                            for (i = 0; i &lt; downEventArr.length; i++) {
    
                                midiData = {
                                    velocity: velocity,
                                    channel: channel,
                                    command: command,
                                    type: type,
                                    note: note
                                };
    
                                downEventArr[i](midiData, input.inputType, index); // fire down event
                            }
    
                        // up
                        } else if (velocity === 0) { 
    
                            var upEventArr = input.eventStack.up;
                            for (i = 0; i &lt; upEventArr.length; i++) {
    
                                midiData = {
                                    velocity: velocity,
                                    channel: channel,
                                    command: command,
                                    type: type,
                                    note: note
                                };
    
                                upEventArr[i](midiData, input.inputType, index); // fire up event
                            }
                        }
                    }
                }
            } 
        };
    
        /**
         * Assigns event handler functions. Valid events include: connect, disconnect, message.
         * @method on
         * @param  {String}   name     Event name. Supports &quot;connect&quot;, &quot;disconnect&quot;, and &quot;message&quot;.
         * @param  {Function} callback Function to run when event occurs.
         */
        BB.MidiDevice.prototype.on = function(name, callback) {
            
            if (typeof name !== &#x27;string&#x27;) {
                throw new Error(&quot;BB.MidiDevice.on: name parameter must be a string type&quot;);
            } else if (typeof callback !== &#x27;function&#x27;) {
                throw new Error(&quot;BB.MidiDevice.on: callback parameter must be a function type&quot;);
            }
    
            if (name === &#x27;connect&#x27;) {
                this._connectEvent = callback;
            } else if (name === &#x27;disconnect&#x27;) {
                this._disconnectEvent = callback;
            } else if (name === &#x27;message&#x27;) {
                this._messageEvent = callback;
            } else {
                throw new Error(&#x27;BB.MidiDevice.on: &#x27; + name + &#x27; is not a valid event name&#x27;);
            }
        };
    
        return BB.MidiDevice;
    });
    
    </pre>
    </div>
            </div>
        </div>

    </div>
</div>

<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>

<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
