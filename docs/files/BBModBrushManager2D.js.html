<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>BBModBrushManager2D.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/BBModBaseBrush2D.html">BBModBaseBrush2D</a></li>
                                <li><a href="../classes/BBModImageBrush2D.html">BBModImageBrush2D</a></li>
                                <li><a href="../classes/BBModLineBrush2D.html">BBModLineBrush2D</a></li>
                                <li><a href="../classes/BBModMouseInput.html">BBModMouseInput</a></li>
                                <li><a href="../classes/BBModPointer.html">BBModPointer</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/BBModBaseBrush2D.html">BBModBaseBrush2D</a></li>
                                <li><a href="../modules/BBModBrushManager2D.html">BBModBrushManager2D</a></li>
                                <li><a href="../modules/BBModImageBrush2D.html">BBModImageBrush2D</a></li>
                                <li><a href="../modules/BBModLineBrush2D.html">BBModLineBrush2D</a></li>
                                <li><a href="../modules/BBModMathUtils.html">BBModMathUtils</a></li>
                                <li><a href="../modules/BBModMouseInput.html">BBModMouseInput</a></li>
                                <li><a href="../modules/BBModPointer.html">BBModPointer</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: BBModBrushManager2D.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * Basic scene manager for brushes and pointers. BBModBrushMangager2D provides
 * functionality to
 * @module BBModBrushManager2D
 */
define([&#x27;./BBModBaseBrush2D&#x27;, &#x27;BBModBaseBrush2D&#x27;, &#x27;BBModPointer&#x27;],
function(  BBModBaseBrush2D,   BBModBaseBrush2D,   BBModPointer ){


    function BBModBrushManager2D(width, height) {

        if (!canvas) {
            throw new Error(&#x27;BBModBrushManager2D: An HTML5 canvas object must be supplied as a first parameter.&#x27;);
        }

        var canv    = document.createElement(&#x27;canvas&#x27;);
        canv.width  = width;
        canv.height = height;

        // document.body.appendChild(canv)
        this.canvas  = canv;

        // this context is used by the brushes internally
        this.context = canv.getContext(&#x27;2d&#x27;);

        this._numUndos = 5; // matches public numUndos w/ getter and setter

        this._history   = []; // array of base-64 encoded img srcs
        this._purgatory = []; // array of undone base-64 encoded img srcs that
                              // can be placed back in history with redo function

        this._fboImage = new Image();


        // https://developer.mozilla.org/en-US/docs/Web/HTML/CORS_enabled_image
        this._fboImage.crossOrigin = &quot;Anonymous&quot;;

        this._pointers = [];
        this._pointerStates = [];

        this._needsUndo = false;
        this._needsRedo = false;
        this._srcLoadWaiting = false;

        // add empty canvas to the history
        this._history.push(this.canvas.toDataURL());
    }

    Object.defineProperty(BBModBrushManager2D.prototype, &quot;numUndos&quot;, {
        get: function() {
            return this._numUndos;
        },
        set: function(val) {
            
            this._numUndos = val;
            
            // remove old undos if they exist
            if (this._numUndos &lt; this._history.length - 1) {
                this._history.splice(0, this._history.length - this._numUndos - 1);
            }
        }
    });

    BBModBrushManager2D.prototype.trackPointers = function(pointers) {
        
        if (pointers instanceof Array) {

            for (var i = 0; i &lt; pointers.length; i++) {
             
                var pointer = pointers[i];
                if (! pointer instanceof BBModPointer) {
                    throw new Error(&#x27;BBModBrushManager2D.trackPointers: pointers[&#x27; 
                        + i + &#x27;] is not an instance of BBModPointer.&#x27;);
                } else {
                    this._pointers.push(pointer);
                    this._pointerStates.push(pointer.isDown);
                }
            }

        } else {
            throw new Error(&#x27;BBModBrushManager2D.trackPointers: pointers parameter must be an array of pointers.&#x27;);
        }
    }

    BBModBrushManager2D.prototype.untrackPointers = function() {
        this._pointers = [];
        this._pointerStates = [];
    }

    BBModBrushManager2D.prototype.untrackPointerAtIndex = function(index) {
        
        if (typeof this._pointers[index] !== &#x27;undefined&#x27;) {
            this._pointers.splice(index, 1);
            this._pointerStates.splice(index, 1);
        } else {
            throw new Error(&#x27;BBModBrushManager2D.untrackPointerAtIndex: Invalid pointer index &#x27; 
                + index + &#x27;. there is no pointer at that index.&#x27;);
        }
    }

    BBModBrushManager2D.prototype.hasPointers = function() {
        return this._pointers.length &gt; 0;
    }

    BBModBrushManager2D.prototype.hasUndo = function() {
        return this._history.length &gt; 1;
    }

    BBModBrushManager2D.prototype.hasRedo = function() {
        return this._purgatory.length &gt; 0;
    }

    BBModBrushManager2D.prototype.update = function() {

        if (! this.hasPointers()) {
            throw new Error(&#x27;BBModBrushManager2D.update: You must add at least one pointer to &#x27;
                            + &#x27;the brush manager with BBModBrushManager2D.addPointers(...)&#x27;);
        }

        console.log(this._purgatory.length);

        for (var i = 0; i &lt; this._pointers.length; i++) {
            
            var pointer = this._pointers[i];

            // state change detected
            if (pointer.isDown === false &amp;&amp;
                this._pointerStates[i] === true) {

                if (this._history.length === this.numUndos + 1) {
                    this._history.shift();
                }

                this._history.push(this.canvas.toDataURL());
            }

            this._pointerStates[i] = pointer.isDown;
        }
    }

    BBModBrushManager2D.prototype.draw = function(context) {

        var self = this;

        function drawToFBOAndContext() {
            self.context.clearRect(0, 0, self.canvas.width, self.canvas.height);
            self.context.drawImage(self._fboImage, 0, 0);
            context.drawImage(self._fboImage, 0, 0); 
        }

        // don&#x27;t override 
        if (!this._srcLoadWaiting) {
            this._fboImage.onload = function() {
                drawToFBOAndContext();
                self._srcLoadWaiting = false;
            }
        }
        
        
        if (this._needsUndo) {
            
            if (this._purgatory.length == this.numUndos + 1) {
                this._purgatory.shift();
            }

            this._purgatory.push(this._history.pop());

            this._fboImage.src = this._history[this._history.length - 1];
            this._srcLoadWaiting = true;
            
            this._needsUndo = false;

        } else if (this._needsRedo) {
            
            if (this._purgatory.length &gt; 0 &amp;&amp;
                !self._srcLoadWaiting) {

                this._fboImage.onload = function() {
                
                    drawToFBOAndContext();

                    if (self._history.length === self.numUndos + 1) {
                        self._history.shift();
                    }

                    self._history.push(self.canvas.toDataURL());
                    self._srcLoadWaiting = false;
                }
                
                this._fboImage.src = this._purgatory.pop();
                this._srcLoadWaiting = true;
                this._needsRedo = false;
            }
        
        } else if (this._pointerStates.some(function(val){ return val === true })) {

            this._fboImage.src = this.canvas.toDataURL();
            this._srcLoadWaiting = true;

            if (this._purgatory.length &gt; 0) {
                this._purgatory = [];
            }
        }
        
        context.drawImage(this._fboImage, 0, 0);    
    }

    BBModBrushManager2D.prototype.undo = function() {

        if (this._history.length &gt; 1) {
            this._needsUndo = true;
        }
    }

    BBModBrushManager2D.prototype.redo = function() {

        if (this._history.length &gt; 0) {
            this._needsRedo = true;
        }
    }

    return BBModBrushManager2D;
});

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
